# Initial-M主题更新日志

## v3.1.2 (2026-02-26)

### 主要修复内容

#### 1. 验证码代码优化与错误修复
- **functions.php**: 删除错误的全局作用域函数调用 `$comment = spam_protection_pre($comment, $post, $result);`，该调用会导致变量未定义错误
- **functions.php**: 删除旧的 `spam_protection_pre()` 函数，避免代码重复
- **functions.php**: 创建新的 `CommentProtection` 验证类，提供更规范的验证码验证逻辑
- **functions.php**: 通过 Typecho 插件工厂正确注册验证逻辑，确保在评论提交时自动触发验证

#### 2. 白屏问题修复
- **header.php**: 修复了由于变量未定义和JSON语法错误导致的白屏问题
- **header.php**: 添加了完善的容错处理，确保即使某些选项未设置也能正常运行

### 主要功能更新

#### 1. 文章排版样式优化
- **style.min.css**: 新增 `.widget-title` 样式优化，添加下划线和装饰效果
- **style.min.css**: 新增 `.post-content p` 段落样式，设置段落间距和对齐方式
- **style.min.css**: 新增 `.post-content h2`、`.post-content h3`、`.post-content h4` 标题样式，优化标题层级和间距
- **style.min.css**: 新增 `.post-content blockquote` 引用样式，添加背景色和左侧边框
- **style.min.css**: 新增 `.post-content ul`、`.post-content ol`、`.post-content li` 列表样式，优化列表项间距和悬停效果
- **style.min.css**: 新增 `.post-content img` 图片样式，添加阴影效果和居中显示
- **style.min.css**: 新增 `.post-content table` 表格样式，优化表格布局和悬停效果
- **style.min.css**: 新增 `.post-content hr` 分隔线样式，调整分隔线宽度
- **style.min.css**: 新增响应式设计的媒体查询，在不同屏幕尺寸下自动调整样式
- **修改效果**: 文章内容排版更加美观，阅读体验显著提升，支持响应式布局

#### 2. SEO优化与结构化数据
- **header.php**: 为主题添加完整的Schema.org结构化数据支持，包括JSON-LD格式
- **header.php**: 添加了统一的描述获取与清洗逻辑，确保JSON-LD结构有效
- **header.php**: 添加了统一的封面图获取逻辑，确保所有页面都有合适的封面图
- **post.php**: 为面包屑导航添加了完整的BreadcrumbList结构化数据
- **post.php**: 为文章页面添加了Article类型的结构化数据，包含标题、日期、评论数等属性
- **修改效果**: 提升了网站在搜索引擎中的表现，改善了社交分享时的显示效果

### 技术变更

#### 1. 验证码实现优化
- **优化方式**: 将验证码验证逻辑从简单函数改为规范的类实现
- **注册方式**: 使用 Typecho 插件工厂钩子注册验证函数，符合 Typecho 开发标准
- **验证时机**: 验证逻辑在评论提交时自动触发，而非在主题加载时调用
- **代码质量**: 代码结构更清晰，逻辑更规范，符合现代 PHP 开发标准

#### 2. 样式代码优化
- **响应式设计**: 实现完整的响应式排版，适配不同屏幕尺寸
- **视觉效果**: 通过阴影、边框、颜色等元素提升视觉层次感
- **用户体验**: 优化交互反馈，如链接悬停、表格行悬停等效果

#### 3. 结构化数据实现
- **实现方式**: 同时使用Microdata和JSON-LD两种格式的结构化数据
- **数据清洗**: 添加了描述内容的数据清洗和转义逻辑，确保JSON-LD结构有效
- **容错处理**: 添加了完善的容错处理，确保即使某些选项未设置也能正常运行
- **页面类型适配**: 根据页面类型自动生成不同的结构化数据

## v3.1.1 (2026-02-25)

### 侧边栏样式与功能优化

#### 1. 新增随机文章模块
- **functions.php**: 新增 `Contents_Post_Random()` 函数，实现随机文章获取
- **sidebar.php**: 新增随机文章侧边栏模块，显示随机文章列表
- **修改效果**: 侧边栏现在可以显示随机文章推荐，增加网站内容曝光率

#### 2. 新增统计模块
- **functions.php**: 新增 `getSiteStats()` 函数，实现网站统计功能，包括文章数量、评论数量、运行时间、总计码字
- **functions.php**: 新增站点运行时间设置选项，支持使用第一篇文章日期或自定义日期
- **sidebar.php**: 新增统计模块侧边栏，显示网站各项统计数据
- **修改效果**: 侧边栏现在可以显示网站统计信息

## v3.1.0 (2026-02-23)

### 主要功能更新

#### 1. 公告栏功能
- **functions.php**: 新增公告栏设置选项，包括开关和内容输入
- **header.php**: 在页面顶部实现公告栏显示
- **functions.php**: 在公告栏设置中添加CSS类名提示和示例样式
- **修改效果**: 支持在网站顶部显示公告内容，支持HTML标签，并提供CSS样式提示
- **使用方法**: 在主题设置中开启公告栏并输入内容即可显示，可使用提供的CSS类名自定义样式

#### 2. Google广告初始化优化
- **post.php**: 在文章底部广告后添加独立的广告初始化 push 语句
- **sidebar.php**: 在侧边栏广告后添加独立的广告初始化 push 语句
- **footer.php**: 删除重复的统一 push 语句，改为各广告位自行初始化
- **修改效果**: 广告初始化更规范、更灵活，只在实际有广告位时才初始化
- **优化原理**: 每个广告位独立管理自己的初始化，避免不必要的重复 push

### 主要修复内容

#### 1. Typecho 1.3.0兼容性修复
- **functions.php**: 优化 `FindContent` 和 `FindContents` 函数，确保返回安全数据类型，避免 null 值传递
- **functions.php**: 修复 `Whisper` 函数中的 null 值传递问题，直接查询数据库并正确处理结果
- **sidebar.php**: 修复最近回复区域的 `FindContent` 使用问题，增加完整的空值检查和 widget 处理
- **sidebar.php**: 修复链接区域的 `FindContents` 使用问题，增加空值检查
- **footer.php**: 修复链接区域的「更多...」链接的 `FindContents` 使用问题，采用安全处理方式
- **修改效果**: 解决 `Widget\Base\Contents::push(): Argument #1 ($value) must be of type array, null given` 错误，确保在 Typecho 1.3.0 环境下正常运行

#### 2. 链接跳转问题修复
- **sidebar.php**: 优化最近回复区域的链接生成逻辑，确保只有在内容有效时才显示链接
- **修改效果**: 修复 a 标签链接无法跳转的问题

#### 3. Gravatar头像源优化
- **functions.php**: 更新Gravatar头像源选项，新增更稳定的国内头像源
- **新增源**: cravatar.com、weavatar.com、cdn.sep.cc
- **移除源**: 移除了一些不可用或速度较慢的旧头像源
- **修改效果**: 提升头像加载速度和稳定性

#### 4. 轻语图片显示修复
- **page-whisper.php**: 修复子评论中图片不显示的问题，使用 `Markdown::convert()` 转换并允许 `<img>` 标签
- **functions.php**: 修复 `Whisper` 函数中 `strip_tags()` 的调用格式
- **修改效果**: 轻语中的图片现在可以正常显示

### 技术变更

#### 1. 兼容性
- 确保在 Typecho 1.1 和 1.3.0 环境下都能正常运行
- 采用向下兼容的空值检查策略，不使用 Typecho 1.3.0 特有 API

### 注意事项

1. **向下兼容性**: 本版本完全兼容 Typecho 1.1，无需担心升级问题
2. **问题原因**: Typecho 1.3.0 对 `Widget_Abstract_Contents::push()` 方法增加了严格的数组类型检查
3. **修复原理**: 在所有使用 `FindContent` 和 `FindContents` 的地方增加空值检查，确保只有有效数据才传递给 `push()` 方法

---

## v3.0.0 (2026-02-15)

### 主要更新内容

#### 1. 分页导航优化
- **archive.php**: 将分页导航显示页码数量从0改为2，使分页更友好
- **index.php**: 将分页导航显示页码数量从0改为2，使分页更友好
- **修改效果**: 首页、分类页、标签页、搜索结果页的分页导航现在会显示更多页码，提升用户体验

#### 2. 标题链接优化
- **archive.php**: 为文章标题链接添加`title`属性，值为文章标题
- **修改效果**: 提升用户体验和SEO效果

#### 3. 回复可见功能
- **functions.php**: 添加回复可见功能，支持使用`[hidden]`标签隐藏内容
- **post.php**: 实现回复可见功能的具体逻辑，只有登录用户或评论回复后才能查看隐藏内容
- **修改效果**: 增强文章互动性，提升用户参与度

#### 4. 主题设置备份功能
- **functions.php**: 添加主题设置备份功能，支持备份、还原和删除主题设置数据
- **修改效果**: 方便用户在修改主题设置前进行备份，避免设置丢失，提升用户体验

#### 5. 评论验证码功能
- **comments.php**: 添加数学验证码防垃圾评论功能，使用`spam_protection_math()`函数
- **functions.php**: 实现评论验证码功能的具体逻辑，包括生成数学验证码和验证用户输入
- **修改效果**: 有效防止垃圾评论，提升网站安全性

#### 6. 公安备案号功能
- **functions.php**: 添加公安备案号设置项
- **footer.php**: 修改备案号显示方式，实现ICP备案号和公安备案号并排显示
- **修改效果**: 支持同时显示ICP备案号和公安备案号，提升网站合规性
- **跳转链接**: 使用最新的备案查询链接，确保用户可以正确访问备案查询网站

#### 7. Google广告功能
- **functions.php**: 添加Google广告设置项，包括Client ID、文章底部广告完整代码、侧边栏广告完整代码、文章底部广告样式、侧边栏广告样式；为设置项增加详细的标识提示，说明后台已配置优化，无需填写完整广告代码
- **footer.php**: 添加Google广告脚本引入，使用延迟加载方式，提升页面加载速度；添加Google链接替换代码，确保reCAPTCHA在某些地区可以正常访问
- **post.php**: 添加文章底部广告代码，直接输出设置中的完整`&lt;ins&gt;`标签内容；支持自定义广告容器样式
- **sidebar.php**: 添加侧边栏广告代码，直接输出设置中的完整`&lt;ins&gt;`标签内容；支持自定义广告容器样式
- **修改效果**: 用户只需在主题设置中填写Google广告的Client ID和核心广告内容，即可自动生成广告代码，支持不同样式的广告，提升用户体验
- **加载方式**: 使用延迟加载广告脚本的方式，避免广告脚本阻塞页面渲染，提高页面加载速度
- **样式定制**: 用户可以在主题设置中为文章底部和侧边栏广告容器自定义CSS样式，提升广告展示效果

#### 8. Google链接替换功能
- **functions.php**: 添加Google reCAPTCHA链接替换设置开关，默认为开启状态
- **footer.php**: 添加Google链接替换代码，根据设置开关决定是否启用，将Google reCAPTCHA的链接从www.google.com替换为www.recaptcha.net
- **修改效果**: 确保reCAPTCHA在某些地区可以正常访问，提升用户体验
- **设置说明**: 在主题设置页面可以开启或关闭此功能，默认为开启状态

### 技术变更

#### 1. 兼容性
- 确保在Typecho 1.3.0环境下正常运行

### 注意事项

1. **升级前备份**: 升级前请备份原有主题文件和设置
2. **兼容性**: 本版本已在Typecho 1.3.0环境下测试通过
3. **回复可见功能使用方法**: 在文章中使用`[hidden]`和`[/hidden]`标签包裹需要隐藏的内容，只有登录用户或评论回复后才能查看
4. **主题设置备份功能使用方法**: 在主题设置页面底部，点击相应按钮即可备份、还原或删除主题设置数据
5. **评论验证码功能**: 已自动集成到评论表单中，无需额外配置
6. **公安备案号功能**: 在主题设置页面填写ICP备案号和公安备案号，会自动在底部并排显示
7. **Google广告功能使用方法**: 在主题设置页面填写Google广告的Client ID，以及文章底部和侧边栏广告的核心内容（如Slot ID或完整的`&lt;ins&gt;`标签内容），还可以为广告容器自定义CSS样式，即可自动生成广告代码；若留空，则广告代码不生效
8. **Google链接替换功能使用方法**: 在主题设置页面可以开启或关闭Google reCAPTCHA链接替换功能，默认为开启状态；开启后会将reCAPTCHA链接从www.google.com替换为www.recaptcha.net，确保在某些地区可以正常访问

### 鸣谢

- 感谢原作者JIElive创建的Initial主题

---

## 历史版本

### v2.5.5 (2023-02-20)
- 修复部分用户背景音乐播放音量无法设置的问题
- 适配返回顶部新算法,修复返回顶部后无法继续下拉的问题

### 更早版本
请参考README.md文件中的详细更新历史
